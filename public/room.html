<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>放映室 - 在线电影放映室</title>
  <meta name="description" content="与朋友同步观看视频">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+SC:wght@300;400;500;700&family=Outfit:wght@300;400;500;600;700&display=swap"
    rel="stylesheet">
  <!-- Video.js -->
  <link href="https://vjs.zencdn.net/8.6.1/video-js.css" rel="stylesheet">
</head>

<body class="room-page">
  <div class="room-container">
    <!-- 顶部导航栏 -->
    <header class="room-header">
      <div class="header-left">
        <a href="/" class="back-btn" title="返回首页">
          <i class="fa-solid fa-arrow-left"></i>
        </a>
        <div class="room-info">
          <i class="fa-solid fa-film room-icon"></i>
          <span class="room-title">放映室</span>
          <span class="room-id-badge" id="room-id-display">----</span>
          <button class="copy-btn" id="copy-room-id" title="复制房间号">
            <i class="fa-solid fa-copy"></i>
          </button>
          <!-- 邀请按钮移到这里 -->
          <button class="btn btn-secondary invite-btn" id="invite-btn" title="邀请好友">
            <i class="fa-solid fa-user-plus"></i>
            <span class="d-none-mobile">邀请</span>
          </button>
          <!-- 屏幕共享按钮 -->
          <button class="btn btn-secondary screen-share-btn" id="screen-share-btn" title="共享屏幕">
            <i class="fa-solid fa-display"></i>
            <span class="d-none-mobile">共享屏幕</span>
          </button>
        </div>
      </div>
      <div class="header-right">
        <!-- 房主标识 -->
        <div class="host-indicator" id="host-indicator" style="display: none;">
          <i class="fa-solid fa-crown"></i>
          <span>房主</span>
        </div>
        <!-- 设置按钮(仅房主可见) -->
        <button class="settings-btn" id="settings-btn" style="display: none;" title="房间设置">
          <i class="fa-solid fa-gear"></i>
        </button>
        <div class="sync-status" id="sync-status">
          <span class="sync-dot"></span>
          <span class="sync-text">已同步</span>
        </div>
        <div class="p2p-status" id="p2p-status" title="P2P 视频共享状态">
          <i class="fa-solid fa-share-nodes"></i>
          <span class="p2p-peers">0</span>
        </div>
        <div class="user-count" id="user-count">
          <i class="fa-solid fa-users user-icon"></i>
          <span class="count">1</span>
        </div>
      </div>
    </header>

    <!-- 主内容区域 -->
    <div class="room-main">


      <!-- 视频播放区域 -->
      <div class="video-section">
        <!-- 视频源输入区域 (Tabbed) -->
        <div class="video-input-tabs">
          <button class="input-tab active" data-target="tab-direct">
            <i class="fa-solid fa-link"></i> 链接/上传
          </button>
          <button class="input-tab" data-target="tab-bilibili">
            <i class="fa-brands fa-bilibili"></i> B站
          </button>
          <button class="input-tab" data-target="tab-parser">
            <i class="fa-solid fa-globe"></i> 解析
          </button>
        </div>

        <div class="video-url-bar">
          <!-- Tab 1: 直链 & 上传 -->
          <div class="input-tab-content active" id="tab-direct">
            <div class="input-action-container">
              <div class="main-input-group">
                <input type="url" id="video-url-input" placeholder="粘贴视频直链 (MP4, M3U8)..." autocomplete="off">
                <button id="load-video-btn" class="load-btn">
                  <span>播放</span>
                </button>
              </div>

              <div class="secondary-actions">
                <button id="upload-video-btn" class="icon-btn" type="button" title="上传视频">
                  <i class="fa-solid fa-file-upload"></i>
                </button>
                <input type="file" id="video-file-input" accept="video/*,.mkv,.avi,.flv,.wmv,.ts"
                  style="display: none;">

                <button id="upload-subtitle-btn" class="icon-btn" type="button" title="上传字幕">
                  <i class="fa-solid fa-closed-captioning"></i>
                </button>
                <input type="file" id="subtitle-file-input" accept=".srt,.ass,.ssa,.sub,.idx" style="display: none;">
              </div>
            </div>
          </div>

          <!-- Tab 2: B站 -->
          <div class="input-tab-content" id="tab-bilibili">
            <div class="input-action-container">
              <div class="main-input-group">
                <input type="text" id="bilibili-url-input" placeholder="粘贴 B站链接或 BV号..." autocomplete="off">
                <button id="parse-bilibili-btn" class="load-btn bilibili-btn">
                  <span>解析</span>
                </button>
              </div>
              <div class="secondary-actions">
                <button id="bilibili-login-btn" class="capsule-btn bilibili-login-btn" type="button" title="登录 B 站账号">
                  <i class="fa-solid fa-user"></i>
                  <span id="bilibili-login-text">登录账号</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Tab 3: 解析 -->
          <div class="input-tab-content" id="tab-parser">
            <div class="input-action-container">
              <div class="main-input-group">
                <input type="text" id="parser-url-input" placeholder="粘贴网页视频链接 (YouTube, 抖音等)..." autocomplete="off">
                <button id="parse-video-btn" class="load-btn parser-btn">
                  <span>解析</span>
                </button>
              </div>
              <div class="secondary-actions">
                <button id="parser-help-btn" class="icon-btn" type="button" title="支持的网站">
                  <i class="fa-solid fa-circle-question"></i>
                </button>
                <button id="parser-rules-btn" class="icon-btn" type="button" title="解析规则">
                  <i class="fa-solid fa-puzzle-piece"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- 公共进度条区域 -->
          <div class="parser-progress" id="parser-progress-container" style="display: none;">
            <div class="progress-info">
              <span class="progress-text" id="parser-progress-text">解析中...</span>
              <span class="progress-percent" id="parser-progress-percent">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="parser-progress-bar"></div>
            </div>
          </div>

          <div class="parser-progress" id="upload-progress" style="display: none;">
            <div class="progress-info">
              <span class="progress-text" id="progress-text">上传中...</span>
              <span class="progress-percent" id="progress-percent">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-fill" id="progress-fill"></div>
            </div>
          </div>

          <div class="transcode-overlay" id="transcode-overlay" style="display: none;">
            <div class="transcode-spinner"></div>
            <span class="transcode-text">正在转码...</span>
          </div>
        </div>

        <!-- 视频播放器 -->
        <!-- Choosen Custom Player Container -->
        <div class="video-wrapper" id="video-wrapper">
          <!-- 屏幕共享覆盖层 (移动到这里) -->
          <div id="screen-share-overlay" class="screen-share-overlay" style="display: none;">
            <video id="screen-share-video" autoplay playsinline></video>
            <div class="screen-share-controls">
              <div class="sharer-info">
                <i class="fa-solid fa-display"></i>
                <span class="sharer-name"></span>
                <span>正在共享屏幕</span>
              </div>
              <!-- 退出按钮已移除 -->
            </div>
          </div>
          <!-- Video Element -->
          <video id="video-player" class="video-js vjs-big-play-centered vjs-theme-cinema" playsinline>
            <p class="vjs-no-js">
              To view this video please enable JavaScript, and consider upgrading to a web browser that supports HTML5
              video
            </p>
          </video>

          <!-- Danmaku Layer -->
          <div id="danmaku-container" class="danmaku-container"></div>

          <!-- Video Placeholder -->
          <div id="video-placeholder" class="video-placeholder">
            <div class="placeholder-content">
              <i class="fa-solid fa-film placeholder-icon"></i>
              <h3>等待视频加载...</h3>
              <p>输入视频链接或上传文件开始观看</p>
            </div>
          </div>

          <!-- Custom Control Bar -->
          <div class="custom-controls" id="custom-controls">
            <!-- Progress Bar -->
            <div class="progress-container" id="progress-container">
              <div class="progress-bar-bg"></div>
              <div class="progress-bar-buffered" id="progress-buffered"></div>
              <div class="progress-bar-current" id="progress-current">
                <div class="progress-handle"></div>
              </div>
            </div>

            <!-- Controls Main -->
            <div class="controls-main">
              <div class="controls-left">
                <button class="control-btn" id="play-pause-btn" title="播放/暂停 (空格)">
                  <i class="fa-solid fa-play"></i>
                </button>
                <div class="time-display">
                  <span id="current-time">00:00</span>
                  <span class="time-separator">/</span>
                  <span id="duration">00:00</span>
                </div>
              </div>

              <!-- Danmaku Input -->
              <div class="danmaku-input-area">
                <div class="danmaku-input-wrapper">
                  <input type="text" id="danmaku-input" placeholder="发送弹幕..." maxlength="50" autocomplete="off">
                  <button id="send-danmaku-btn" class="send-btn">发送</button>
                </div>
              </div>

              <div class="controls-right">
                <button class="control-btn active" id="danmaku-toggle-btn" title="弹幕开关 (D)">
                  <i class="fa-solid fa-comment-dots"></i>
                </button>

                <div class="volume-container">
                  <button class="control-btn" id="volume-btn" title="音量 (M)">
                    <i class="fa-solid fa-volume-high"></i>
                  </button>
                  <div class="volume-slider-wrapper">
                    <input type="range" id="volume-slider" min="0" max="1" step="0.1" value="1">
                  </div>
                </div>

                <!-- Audio Track Selector -->
                <div class="track-selector audio-selector" id="audio-selector" style="display: none;">
                  <button class="control-btn" title="音轨选择">
                    <i class="fa-solid fa-music"></i>
                  </button>
                  <div class="selector-menu audio-menu" id="audio-menu">
                    <!-- Dynamically populated -->
                  </div>
                </div>

                <!-- Subtitle Selector -->
                <div class="track-selector subtitle-selector" id="subtitle-selector">
                  <button class="control-btn" title="字幕设置">
                    <i class="fa-solid fa-closed-captioning"></i>
                  </button>
                  <div class="selector-menu subtitle-menu" id="subtitle-menu">
                    <div class="menu-item active" data-mode="off">关闭字幕</div>
                  </div>
                </div>

                <div class="speed-selector">
                  <span id="current-speed">1.0x</span>
                  <div class="speed-menu">
                    <div class="speed-option" data-speed="2.0">2.0x</div>
                    <div class="speed-option" data-speed="1.5">1.5x</div>
                    <div class="speed-option" data-speed="1.25">1.25x</div>
                    <div class="speed-option" data-speed="1.0">1.0x</div>
                    <div class="speed-option" data-speed="0.75">0.75x</div>
                    <div class="speed-option" data-speed="0.5">0.5x</div>
                  </div>
                </div>

                <button class="control-btn" id="fullscreen-btn" title="全屏 (F)">
                  <i class="fa-solid fa-expand"></i>
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- 视频控制提示 & 弹幕开关 -->
        <div class="video-controls-hint" id="video-hint" style="display: none;">
          <div class="hint-left">
            <i class="fa-solid fa-lightbulb hint-icon"></i>
            <span class="hint-text">你的播放操作会同步给房间内所有人</span>
          </div>
          <button id="toggle-danmaku-btn" class="toggle-btn active" title="开启/关闭弹幕">
            <i class="fa-solid fa-comment-dots"></i>
            <span>弹幕: 开</span>
          </button>
        </div>
      </div>

      <!-- 侧边栏 -->
      <aside class="sidebar">
        <!-- 用户列表 -->
        <div class="sidebar-section users-section">
          <div class="section-header">
            <i class="fa-solid fa-users section-icon"></i>
            <h3>在线用户</h3>
          </div>
          <ul class="user-list" id="user-list">
            <!-- 用户列表将通过 JS 动态填充 -->
          </ul>
        </div>

        <!-- 聊天区域 -->
        <div class="sidebar-section chat-section">
          <div class="section-header">
            <i class="fa-solid fa-comments section-icon"></i>
            <h3>聊天</h3>
          </div>
          <div class="chat-messages" id="chat-messages">
            <div class="chat-welcome">
              <p>欢迎来到放映室！</p>
              <p class="welcome-hint">在这里和朋友边看边聊 😊</p>
            </div>
          </div>
          <form class="chat-input-form" id="chat-form">
            <input type="text" id="chat-input" placeholder="发送消息..." maxlength="500" autocomplete="off">
            <button type="submit" class="send-btn">
              <span>发送</span>
            </button>
          </form>
        </div>
      </aside>
    </div>
  </div>

  <!-- 系统通知 -->
  <div id="notification" class="notification"></div>

  <!-- Toast 提示 -->
  <div id="toast" class="toast"></div>

  <!-- 连接状态遮罩 -->
  <div class="connection-overlay" id="connection-overlay">
    <div class="connection-modal">
      <div class="loading-spinner"></div>
      <p id="connection-status-text">正在连接...</p>
    </div>
  </div>

  <!-- 加入房间模态框 (用于通过链接进入) -->
  <div id="join-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="join-modal-header">加入放映室</h3>
      </div>
      <div class="modal-body">
        <p id="join-modal-desc">请输入你的昵称以加入房间</p>
        <div class="input-group">
          <label for="join-name-input">昵称</label>
          <input type="text" id="join-name-input" placeholder="你的昵称" maxlength="10">
        </div>
        <div class="input-group" id="join-password-group" style="display: none;">
          <label for="join-password-input">房间密码</label>
          <input type="password" id="join-password-input" placeholder="输入房间密码" maxlength="20">
        </div>
        <p id="join-error" class="error-text"></p>
      </div>
      <div class="modal-footer">
        <button id="join-btn" class="btn btn-primary primary-glow" style="width: 100%;">加入房间</button>
      </div>
    </div>
  </div>

  <!-- 房间设置模态框 -->
  <div id="settings-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>房间设置</h3>
        <button class="modal-close-btn" id="settings-close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="settings-section">
          <h4>权限管理</h4>
          <div class="permission-item">
            <div class="permission-info">
              <label>允许所有人更换视频</label>
              <span class="permission-desc">开启后所有用户都可以上传和切换视频</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="allow-video-switch">
              <span class="slider"></span>
            </label>
          </div>
          <div class="permission-item">
            <div class="permission-info">
              <label>允许所有人更换字幕</label>
              <span class="permission-desc">开启后所有用户都可以上传和切换字幕</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="allow-subtitle-switch">
              <span class="slider"></span>
            </label>
          </div>
          <div class="permission-item">
            <div class="permission-info">
              <label>允许所有人控制播放</label>
              <span class="permission-desc">开启后所有用户都可以播放/暂停/跳转</span>
            </div>
            <label class="switch">
              <input type="checkbox" id="allow-control-switch">
              <span class="slider"></span>
            </label>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="save-settings-btn" class="btn btn-primary">保存设置</button>
      </div>
    </div>
  </div>

  <!-- 修改昵称模态框 -->
  <div id="nickname-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h3>修改昵称</h3>
        <button class="modal-close-btn" id="nickname-close">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <label>新昵称</label>
          <input type="text" id="new-nickname-input" placeholder="输入新昵称" maxlength="10">
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancel-nickname-btn" class="btn btn-secondary">取消</button>
        <button id="save-nickname-btn" class="btn btn-primary">确定</button>
      </div>
    </div>
  </div>

  <!-- B 站扫码登录弹窗 -->
  <div id="bilibili-qrcode-modal" class="modal-overlay">
    <div class="modal-content bilibili-modal">
      <div class="modal-header">
        <h3><i class="fa-brands fa-bilibili"></i> 登录 B 站</h3>
        <button class="modal-close-btn" id="bilibili-qrcode-close" title="关闭">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body bilibili-qrcode-body">
        <div class="qrcode-container" id="qrcode-container">
          <div class="qrcode-loading">
            <div class="loading-spinner"></div>
            <p>正在生成二维码...</p>
          </div>
        </div>
        <p class="qrcode-hint">使用 B 站 App 扫码登录</p>
        <p class="qrcode-status" id="qrcode-status"></p>
      </div>
    </div>
  </div>

  <!-- B 站视频信息弹窗 -->
  <div id="bilibili-video-modal" class="modal-overlay">
    <div class="modal-content bilibili-video-modal">
      <div class="modal-header">
        <h3><i class="fa-brands fa-bilibili"></i> B 站视频</h3>
        <button class="modal-close-btn" id="bilibili-video-close" title="关闭">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="bilibili-video-info" id="bilibili-video-info">
          <img class="video-cover" id="bilibili-cover" src="" alt="封面">
          <div class="video-details">
            <h4 class="video-title" id="bilibili-title"></h4>
            <p class="video-author" id="bilibili-author"></p>
            <div class="video-stats" id="bilibili-stats"></div>
          </div>
        </div>
        <div class="bilibili-options">
          <div class="option-group">
            <label>选择分P：</label>
            <select id="bilibili-page-select" class="bilibili-select">
              <!-- 动态填充 -->
            </select>
          </div>
          <div class="option-group">
            <label>选择清晰度：</label>
            <select id="bilibili-quality-select" class="bilibili-select">
              <!-- 动态填充 -->
            </select>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="bilibili-play-btn" class="btn btn-primary bilibili-play-btn">
          <i class="fa-solid fa-play"></i> 播放视频
        </button>
        <!-- 下载进度条 -->
        <div id="bilibili-progress-container" class="bilibili-progress-container" style="display: none;">
          <div class="progress-info">
            <span id="bilibili-progress-text">准备下载...</span>
            <span id="bilibili-progress-percent">0%</span>
          </div>
          <div class="progress-bar-bg">
            <div id="bilibili-progress-bar" class="progress-bar-fill" style="width: 0%"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- 屏幕共享设置弹窗 -->
  <div id="screen-share-settings-modal" class="modal-overlay">
    <div class="modal-content screen-share-settings-modal">
      <div class="modal-header">
        <h3><i class="fa-solid fa-display"></i> 屏幕共享设置</h3>
        <button class="modal-close-btn" id="screen-share-settings-close" title="关闭">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- 分辨率 -->
        <div class="setting-group">
          <label><i class="fa-solid fa-expand"></i> 分辨率</label>
          <div class="preset-buttons" id="resolution-presets">
            <button class="preset-btn" data-value="1280x720">720p</button>
            <button class="preset-btn active" data-value="1920x1080">1080p</button>
            <button class="preset-btn" data-value="2560x1440">1440p</button>
            <button class="preset-btn" data-value="3840x2160">4K</button>
            <button class="preset-btn" data-value="custom">自定义</button>
          </div>
          <div class="custom-input-row" id="resolution-custom" style="display: none;">
            <input type="number" id="custom-width" placeholder="宽度" min="640" max="7680">
            <span>×</span>
            <input type="number" id="custom-height" placeholder="高度" min="360" max="4320">
          </div>
        </div>

        <!-- 帧率 -->
        <div class="setting-group">
          <label><i class="fa-solid fa-gauge-high"></i> 帧率 (FPS)</label>
          <div class="preset-buttons" id="framerate-presets">
            <button class="preset-btn" data-value="24">24</button>
            <button class="preset-btn active" data-value="30">30</button>
            <button class="preset-btn" data-value="60">60</button>
            <button class="preset-btn" data-value="custom">自定义</button>
          </div>
          <div class="custom-input-row" id="framerate-custom" style="display: none;">
            <input type="number" id="custom-framerate" placeholder="帧率" min="1" max="144">
            <span>FPS</span>
          </div>
        </div>

        <!-- 码率 -->
        <div class="setting-group">
          <label><i class="fa-solid fa-chart-line"></i> 码率</label>
          <div class="preset-buttons" id="bitrate-presets">
            <button class="preset-btn" data-value="1000">1 Mbps</button>
            <button class="preset-btn" data-value="2500">2.5 Mbps</button>
            <button class="preset-btn active" data-value="5000">5 Mbps</button>
            <button class="preset-btn" data-value="8000">8 Mbps</button>
            <button class="preset-btn" data-value="custom">自定义</button>
          </div>
          <div class="custom-input-row" id="bitrate-custom" style="display: none;">
            <input type="number" id="custom-bitrate" placeholder="码率" min="500" max="50000">
            <span>Kbps</span>
          </div>
        </div>

        <!-- 当前设置预览 -->
        <div class="settings-preview">
          <span id="settings-preview-text">1920×1080 @ 30fps, 5 Mbps</span>
        </div>
      </div>
      <div class="modal-footer">
        <button id="screen-share-cancel-btn" class="btn btn-secondary">取消</button>
        <button id="screen-share-start-btn" class="btn btn-primary">
          <i class="fa-solid fa-display"></i> 开始共享
        </button>
      </div>
    </div>
  </div>

  <!-- 视频解析预览弹窗 -->
  <div id="parser-preview-modal" class="modal-overlay">
    <div class="modal-content parser-modal">
      <div class="modal-header">
        <h3><i class="fa-solid fa-video"></i> 视频预览</h3>
        <button class="modal-close-btn" id="parser-modal-close" title="关闭">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <div class="parser-preview">
          <img id="parser-thumbnail" class="parser-thumbnail" src="" alt="视频封面">
          <div class="parser-info">
            <h4 id="parser-title" class="parser-title">视频标题</h4>
            <p id="parser-duration" class="parser-meta"><i class="fa-solid fa-clock"></i> <span>--:--</span></p>
            <p id="parser-uploader" class="parser-meta"><i class="fa-solid fa-user"></i> <span>--</span></p>
            <p id="parser-site" class="parser-meta"><i class="fa-solid fa-globe"></i> <span>--</span></p>
          </div>
        </div>
        <div class="parser-quality-selector" id="parser-quality-selector" style="display: none;">
          <label><i class="fa-solid fa-sliders"></i> 选择画质</label>
          <select id="parser-quality-select">
            <option value="best">自动 (最佳)</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button id="parser-cancel-btn" class="btn btn-secondary">取消</button>
        <button id="parser-confirm-btn" class="btn btn-primary">
          <i class="fa-solid fa-play"></i> 加载视频
        </button>
      </div>
    </div>
  </div>

  <!-- 支持网站列表弹窗 -->
  <div id="parser-sites-modal" class="modal-overlay">
    <div class="modal-content parser-sites-modal">
      <div class="modal-header">
        <h3><i class="fa-solid fa-globe"></i> 支持的网站</h3>
        <button class="modal-close-btn" id="parser-sites-close" title="关闭">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <p class="parser-sites-hint">支持以下网站及 yt-dlp 支持的 1000+ 其他网站：</p>
        <div class="parser-sites-grid" id="parser-sites-grid">
          <!-- 动态填充 -->
        </div>
        <div class="parser-sites-note">
          <i class="fa-solid fa-info-circle"></i>
          <span>B站视频请使用上方的专用解析按钮以获得更好体验</span>
        </div>
      </div>
      <div class="modal-footer">
        <button id="parser-sites-ok-btn" class="btn btn-primary">知道了</button>
      </div>
    </div>
  </div>

  <!-- 解析规则管理弹窗 -->
  <div id="parser-rules-modal" class="modal-overlay">
    <div class="modal-content parser-rules-modal">
      <div class="modal-header">
        <h3><i class="fa-solid fa-puzzle-piece"></i> 解析规则管理</h3>
        <button class="modal-close-btn" id="rules-modal-close" title="关闭">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <div class="modal-body">
        <!-- 标签页切换 -->
        <div class="rules-tabs">
          <button class="rules-tab active" data-tab="list">
            <i class="fa-solid fa-list"></i> 规则列表
          </button>
          <button class="rules-tab" data-tab="add">
            <i class="fa-solid fa-plus"></i> 添加规则
          </button>
          <button class="rules-tab" data-tab="test">
            <i class="fa-solid fa-flask"></i> 测试规则
          </button>
        </div>

        <!-- 规则列表标签页 -->
        <div class="rules-tab-content active" id="rules-tab-list">
          <div class="rules-toolbar">
            <button id="reload-rules-btn" class="btn btn-sm btn-secondary">
              <i class="fa-solid fa-rotate"></i> 重新加载
            </button>
            <span class="rules-count" id="rules-count">已加载 0 条规则</span>
          </div>
          <div class="rules-list" id="rules-list">
            <!-- 动态填充 -->
            <div class="rules-loading">
              <i class="fa-solid fa-spinner fa-spin"></i> 加载中...
            </div>
          </div>
        </div>

        <!-- 添加规则标签页 -->
        <div class="rules-tab-content" id="rules-tab-add">
          <div class="rules-form">
            <div class="form-group">
              <label for="rule-filename">文件名 (可选)</label>
              <input type="text" id="rule-filename" placeholder="my-rule.json" class="form-input">
            </div>
            <div class="form-group">
              <label for="rule-json">
                规则 JSON
                <a href="/parsers/rules/RULES_GUIDE.md" target="_blank" class="help-link">
                  <i class="fa-solid fa-circle-question"></i> 查看编写指南
                </a>
              </label>
              <textarea id="rule-json" class="form-textarea" rows="15" placeholder='{
  "name": "我的规则",
  "version": "1.0.0",
  "author": "作者",
  "description": "规则描述",
  "priority": 10,
  "match": {
    "domains": ["example.com"]
  },
  "extract": [
    {
      "type": "regex",
      "pattern": "(https?://[^\"]+\\.m3u8[^\"]*)",
      "group": 1
    }
  ],
  "output": {
    "type": "auto"
  }
}'></textarea>
            </div>
            <div class="form-actions">
              <button id="add-rule-btn" class="btn btn-primary">
                <i class="fa-solid fa-plus"></i> 添加规则
              </button>
            </div>
          </div>
        </div>

        <!-- 测试规则标签页 -->
        <div class="rules-tab-content" id="rules-tab-test">
          <div class="rules-form">
            <div class="form-group">
              <label for="test-url">测试 URL</label>
              <input type="url" id="test-url" placeholder="https://example.com/video/123.html" class="form-input">
            </div>
            <div class="form-group">
              <label for="test-rule-json">规则 JSON (留空则使用已加载的规则)</label>
              <textarea id="test-rule-json" class="form-textarea" rows="10"
                placeholder="留空测试已有规则，或粘贴自定义规则 JSON"></textarea>
            </div>
            <div class="form-actions">
              <button id="test-rule-btn" class="btn btn-primary">
                <i class="fa-solid fa-play"></i> 测试解析
              </button>
            </div>
            <div class="test-result" id="test-result" style="display: none;">
              <h4><i class="fa-solid fa-check-circle"></i> 测试结果</h4>
              <pre id="test-result-content"></pre>
            </div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="rules-modal-ok-btn" class="btn btn-secondary">关闭</button>
      </div>
    </div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script src="https://unpkg.com/hls.js@latest/dist/hls.min.js"></script>
  <script src="https://vjs.zencdn.net/8.6.1/video.min.js"></script>
  <script src="js/p2p-loader.js"></script>
  <script src="js/room.js"></script>
</body>

</html>